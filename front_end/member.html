<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>良耕野菜-會員中心</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="icon" href="../images/logo-02.svg">
    <script src="../js/jquery-3.6.0.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
      function Logout(){
        $.ajax({
          method:'POST',
          url:'../php/Logout.php',
          dataType: 'json',
          data:{},
          success : function(response) {
            console.log(response);
            if(response == 1) {
              alert('已為您登出，並跳轉首頁');
              window.location.href = './index.html';
            }
          },
          error: function(exception) {
              console.log(exception);
              alert("發生錯誤: " + exception.status);
          },
        })
      };
      function ifMember(){
        $.ajax({
              method: 'POST',
              url: '../php/ifMember.php',
              data:{},
              dataType: 'text',
              success: function(response) {
                console.log(response);
                if(response == 'yes'){
                  $('.nav_block_log > span').text('會員中心');
                  $('.login').click(function(){
                    window.location.href = 'member.html';
                  });
                }else{
                  $('.login').click(function(){
                    window.location.href = 'login.html';
                  });
                }
              },
              error: function(exception) {
                  console.log(exception)
                  alert("發生錯誤: " + exception.status);
              },
        });  
      }
    </script>
  </head>
  <body onload="ifMember()">
    <header class="header">
      <!-- 手機板header -->
      <div class="fixed_top"></div>
      <!-- 手機板header結束 -->
      <div class="menu_fixed"></div>

      <div class="menu">
        <div class="logo_img">
          <a href="./index.html">
            <img src="../images/logo.svg" alt="logo" />
          </a>
        </div>
        <div class="page_list">
          <a href="./event.html">農村體驗</a>
          <a href="./fruit_box.html">客製蔬果箱</a>
          <a href="./game.html">蔬果知識小遊戲</a>
          <a href="./aboutUs.html">關於我們</a>
          <a href="./q_a.html">問與答</a>
          <a href="./shopping_page.html">新鮮蔬果</a>
        </div>
      </div>
      <div class="title">
        <div class="title_btn">
          <button class="comm_us">
            聯絡我們 <img src="../images/cotact_us.svg" width="25px" alt="" />
          </button>
          <a class="buy_now" href="./shopping_page.html">
            立即買<img src="../images/buy_now.svg" width="25px" alt="" />
          </a>
        </div>
        <div class="title_pic">
          <img
            src="../images/member/member_01.jpg"
            alt="checkout_pic"
            style="padding-bottom: 100px;"
          />
          <span class="bkc_black"></span>
          <h1>會員中心</h1>
        </div>
      </div>

      <!-- 漢堡彈窗 -->
      <div class="jump_hamburger_block"></div>
      <!-- 漢堡彈窗結束 -->
      
      <!-- 聯絡我們彈窗 -->
      <div class="index_contact_box"></div>
      <!-- 聯絡我們彈窗 -->

      <!-- 購物車彈窗  -->
      <div class="cart_bk"></div>
      <div class="header_shopping_cart"></div>
      <!-- 購物車彈窗結束  -->

      <div class="scrollbar" id="style-6">
        <div class="force-overflow"></div>
      </div>

    </header>

    <!-- 本頁內容 -->

    <div class="member_logout_block">
        <button onclick="Logout()">登出<img src="../images/member/logout_icon.svg" alt=""></button>
        <h3>持有購物金:<span class="discount_money">0</span>元</h3>
    </div>

    <!-- vue範圍開始 -->
    <div class="member_block" id="member_block">
        <div class="member_block_nav">
            <div @click="show_member" class="member_detail">會員資料</div>
            <div @click="show_order" class="member_order">訂單查詢</div>
            <div @click="show_active" class="member_active">活動查詢</div>
            <div @click="show_message" class="member_message">留言板</div>
        </div>
        <div class="member_right_member" v-if="memberShow">
          <h3>會員資料</h3>
          <div class="member_right_detail">
            <div class="member_pic_block">
              <img src="../images/member/member_fake_img.svg" alt="大頭照">
              <button class="member_pwd_change" @click="show_up">
                <img src="../images/member/member_pen.svg" alt="pen">變更密碼
              </button>
            </div>
            <!-- 會員資料印出 -->
            <div class="member_detail_info">
              <div class="member_info_name">
                姓名:
                <input type="text" :disabled="onChange" v-model="member_name">
              </div>
              <div class="member_info_phone">
                手機:
                <input type="text" :disabled="onChange" v-model="member_phone">
              </div>
              <div class="member_info_address">
                地址:
                <input type="text" :disabled="onChange" v-model="member_address">
              </div>
              <div class="member_info_mail">
                郵件:
                <input type="text" disabled v-model="member_mail">
              </div>
              
            </div>
          </div>
          <button class="member_change_detail" @click="changeWord">
            <img src="../images/member/member_pen.svg" alt="筆">
            <span>編輯會員資料</span>
          </button>
        </div>
        <!-- 變更密碼彈窗 -->
        <div class="change_pwd_box" >
          <div class="pwd_black_block" @click="show_up"></div>
          <div class="change_pwd_block">
              <div class="pwd_block_head">
                <button class="pwd_block_Xmark" @click="show_up"></button>
              </div>
              <h2>變更密碼</h2>
              <div class="change_box">
                <input type="text" id="old_pwd1" placeholder="請輸入原本密碼">
                <input type="text" id="old_pwd2" placeholder="請再次輸入">
                <input type="text" id="new_pwd" placeholder="請輸入新密碼">
              </div>
              <input type="button" class="change_send" value="確認變更" @click="change_pwd">
          </div>
        </div>

        <!-- 訂單開始 -->
        <div class="member_order_detail" v-if="orderShow">
            <h3>訂單查詢</h3>
            <div class="member_order_block" v-for="(order,index) in orders">
              <div class="order_box">
                <div class="order_line">
                  <h4>下單時間</h4>
                  <h4>訂單編號</h4>
                  <h4>付款方式</h4>
                  <h4>訂單金額</h4>
                  <h4>配送狀態</h4>
                </div>
                <div class="order_inside_detail">
                  <h4>{{order.ADD_DATE}}</h4>
                  <h4>{{order.ORDER_ID}}</h4>
                  <h4>{{order.PAYMENT}}</h4>
                  <h4>{{order.ORDER_PRICE}}</h4>
                  <h4>{{order.ORDER_STATUS_TYPE_NAME}}</h4>
                </div>
              </div>
              <hr>
              <div @click="turn_on(index)" class="show_order_detail" :id="index">
                訂單內容
                <img class="member_arrow_icon" src="../images/member/member_arrow_icon.svg" alt="">
                <div class="member_check_order_detail">
                  <div class="check_order_box">
                    <div class="show_order_detail_block">
                      <section v-for="detail in block_details" :class="detail.class">{{detail.name}}</section>
                    </div>

                    <!-- 訂單內容迴圈出現 -->
                    <div class="show_order_product_detail" v-for="item in order_detail">
                      <section class="show_order_product_detail_img">
                        <img :src="item.PRODUCT_OUT_IMG">
                      </section>
                      <section class="show_order_product_detail_name">{{item.PRODUCT_NAME}}</section>
                      <section class="show_order_product_detail_sum">
                        {{item.QUANTITY}}
                      </section>
                      <section class="show_order_product_detail_price">{{item.PRODUCT_PRICE}}</section>
                      <section class="show_order_product_detail_total">{{item.ORDER_DETAIL_PRICE}}</section>
                    </div>
                    <div class="show_order_product_detail" v-for="box in box_detail">
                      <section class="show_order_product_detail_img">
                        <img :src="box.CUSTOM_MADE_IMG" />
                      </section>
                      <section class="show_order_product_detail_name">{{box.CUSTOM_MADE_NAME}}</section>
                      <section class="show_order_product_detail_sum">
                        {{box.QUANTITY}}
                      </section>
                      <section class="show_order_product_detail_price">{{box.CUSTOM_MADE_PRICE}}</section>
                      <section class="show_order_product_detail_total">{{box.ORDER_DETAIL_PRICE}}</section>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 活動查詢  -->
          <div class="member_active_detail" v-if="activeShow">
            <h3>活動查詢</h3>
            <div class="member_active_block">
              <div class="active_box">
                <div class="active_line">
                  <h4 v-for="item in active_line">{{item}}</h4>
                </div>

                <!-- 撈出資料庫資料並秀出 使用v-for製造多個訂單資訊 -->
                <div class="active_inside_detail" v-for="item in actives">
                  <h4>{{item.APPOINTMENT_ID}}</h4>
                  <h4>{{item.ACTIVITY_NAME}}</h4>
                  <h4>{{item.APPOINTMENT_DATE}}</h4>
                  <h4>{{item.ACTIVITY_PRICE}}</h4>
                  <h4>{{item.PEOPLE_NUM}}</h4>
                </div>
              </div>
            </div>
          </div>

          <div class="member_message_detail" v-if="messageShow">
            <h3>留言板</h3>
            <div class="member_message_block">
              <div class="message_line">良耕野菜</div>
              <div class="message_inside_detail">
                <h3 class="no_message">目前尚未收到您的任何訊息</h3>
                <textarea class="your_question" rows="5" placeholder="請寫下您的疑問" v-model="your_question"></textarea>
                <div class="member_message_button">
                  <input type="file" id="message_img">
                  <label for="message_img">加入圖片</label>
                  <input type="button" value="傳送" id="message_submit" @click ='send_message'>
                </div>
              </div>
            </div>
          </div>  
    </div>
    <footer class="footer_bg">
      <img class="member_footer_img" src="../images/member/member_footer.svg" alt="for_footer">
      <div class="footer">
        <button class="go_top" id="go_top">
          <img src="../images/top.svg" alt="top">
        </button>
        <div class="footer_logo">
          <a href="./index.html">
            <img src="../images/logo.svg" alt="logo" />
          </a>
        </div>
        <div class="footer_center">
          <h4>電話:02-26938800</h4>
          <h5>營業時間: 星期二至星期日(10:00 - 17:00)</h5>
          <h5>※農曆過年假期本農場也公休
            網路接單為24小時</h5>
          <h5>※當日訂單最晚收到17:00</h5>
          <h5>(17:00後下單視為隔日下單)</h5>
          <div class="btn_pos">
            <button class="mail_btn">
              <img src="../images/mail.svg" alt="mail">MAIL
            </button>
          </div>
          <div class="footer_icon">
            <img src="../images/icon-fb.svg" alt="fb">
            <img src="../images/icon-line.svg" alt="line">
            <img src="../images/icon-ig.svg" alt="ig">
          </div>
        </div>
        <div class="footer_right">
          <div class="right_main">
            <a href="./index.html">首頁</a>
            <a href="./event.html">農村體驗</a>
            <a href="./game.html">蔬果知識小遊戲</a>
            <a href="./aboutUs.html">關於我們</a>
            <a href="./q_a.html">問與答</a>
          </div>
          <div class="right_buy">
            <a href="./fruit_box.html">客製蔬果箱</a>
            <a href="./shopping_page.html">蔬菜</a>
            <a href="./shopping_page.html">水果</a>
          </div>
        </div>
      </div>
      <div><center>本網站為緯育TibaMe前端設計工程師班第66期第4組學員專題成果作品，本平台僅供學習、展示之用。
        若有侵權疑慮，您可以私訊[TibaMe-前端設計工程師養成班]，後續會由專人協助處理。</center></div>
    </footer>
    
    <script src="../js/right_nav_bar.js"></script>
    <script src="../js/shopping_cart.js"></script>
    <script src="../js/header.js"></script>
    <script>
      // 回頁首
      $("#go_top").on("click", function (e) {
      e.preventDefault();
      $('html, body').animate({
          scrollTop: 0
        }, 750);
      });
      

      var member_block = new Vue({
        el:"#member_block",
        data:{
          member_name:"",
          member_phone:"",
          member_mail:"",
          member_address:"",
          active_line:[
            '預約編號',
            '活動內容',
            '預約日期',
            '金額',
            '人數'
          ],

          onChange:true,

          isActive: false,
          memberShow:true,
          orderShow:false,
          activeShow:false,
          messageShow:false,

          your_question: "",

          actives:[],
          orders:[],
          order_detail:[],
          box_detail:[],
          block_details:[
            {class:'show_order_detail_img', name:'商品圖片'},
            {class:'show_order_detail_name', name:'商品名稱'},
            {class:'show_order_detail_sum', name:'數量'},
            {class:'show_order_detail_price', name:'單價'},
            {class:'show_order_detail_total', name:'小計'},
          ],
        },
        methods: {
          turn_on(index){
            if(!$('.member_arrow_icon').hasClass('turn_on')){
              this.order_detail = [];
              this.box_detail = [];
              let order_id = this.orders[index].ORDER_ID;
              console.log(order_id);
              console.log(typeof(order_id));
              axios.post('../php/getOrder_detail.php',{
                order_id: order_id
                }).then(res =>{
                console.log(res.data);
                this.order_detail = res.data;
              });
              axios.post('../php/getOrder_custom.php',{
                order_id: order_id
                }).then(res =>{
                console.log(res.data);
                this.box_detail = res.data;
              });
            }
            let order_item = document.getElementsByClassName('show_order_detail')[index];
            $(order_item).children('.member_arrow_icon').toggleClass('turn_on');
            $(order_item).children('.member_check_order_detail').slideToggle();
          },
          show_member(){
            this.memberShow = true;
            this.orderShow = false;
            this.activeShow = false;
            this.messageShow = false;
          },
          show_order(){
            this.orderShow = true;
            this.memberShow = false;
            this.activeShow = false
            this.messageShow = false;
          },
          show_active(){
            this.orderShow = false;
            this.memberShow = false;
            this.activeShow = true;
            this.messageShow = false;
          },
          show_message(){
            this.orderShow = false;
            this.memberShow = false;
            this.activeShow = false;
            this.messageShow = true;
          },
          changeWord() {
            this.onChange = !this.onChange;
            if(this.onChange == false){
              $('.member_change_detail > span').text('儲存變更');
              $('.member_detail_info input').css('background-color', '#FFF')
            }else{
              $('.member_change_detail > span').text('編輯會員資料');
              $('.member_detail_info input').css('background-color', '#FFF7D2');
              this.change_detail();
            }
          },
          show_up(){
            $('.change_pwd_box').fadeToggle();
            console.log('aaa')
          },
          send_message(){
            let val = $('.your_question').val();
            $('.no_message').fadeOut();
            $('.message_inside_detail').prepend(
              `<div class="customer_message">
                    <div class="customer_message_left">
                      <span>會員</span>
                    </div>
                    <div class="customer_message_right">
                      ${this.your_question}    
                    </div>       
                </div>
            `);
            this.your_question = "";
          },
          change_detail(){
            $.ajax({
              method:'POST',
              url:'../php/change_detail.php',
              data:{
                name: this.member_name,
                hb: this.member_hb,
                phone: this.member_phone,
                address: this.member_address,
              },
              dataType: 'json',
              success: function(response){
                if(response == 1){
                  alert('會員資料更新完成');
                }
              },
              error: function(exception) {
                  alert("發生錯誤: " + exception.status);
                  console.log(exception)
              },
            })
          },
          change_pwd(){
            if($('#old_pwd1').val() == $('#old_pwd2').val()){
              $.ajax({
                method:'POST',
                url:'../php/change_pwd.php',
                data:{
                  old_pwd: $('#old_pwd1').val(),
                  new_pwd: $('#new_pwd').val(),
                },
                dataType: 'json',
                success: function(response){
                  if(response == 1){
                    alert('密碼變更完成');
                  }else{
                    alert('密碼錯誤');
                    console.log(response)
                  }
                },
                error: function(exception) {
                    alert("發生錯誤: " + exception.status);
                    console.log(exception)
                },
              })
            }else{
              alert('請確認兩次密碼是否相同')
            }
          }
        },
        computed:{
          order_list(){
            return this.orders.filter(function(order){
              return +order.ORDER_ID === 1;
            })
          }
        },
        mounted() {
          // 串接活動
          $.ajax({
            method: 'POST',
            url: '../php/getActive.php',
            data:{},
            dataType: 'json',
            success: function(response) {
              member_block.actives = response;
              console.log(response);
            },
            error: function(exception) {
                alert("發生錯誤: " + exception.status);
                console.log(exception)
            },
          }),
          // 取得會員資料&購物金
          $.ajax({
            method: 'POST',
            url: '../php/getMember.php',
            data:{},
            dataType: 'json',
            success: function(response) {
              console.log(response);
              response.forEach(function(index,i){
                member_block.member_name = index['NAME'];
                member_block.member_mail = index['EMAIL'];
                member_block.member_phone = index['PHONE'];
                member_block.member_address = index['ADDRESS'];
                if(index['DISCOUNT'] > 0){
                  $('.discount_money').text(index['DISCOUNT'])
                }
              })
            },
            error: function(exception) {
              alert("發生錯誤: " + exception.status);
              console.log(exception);
            },
          }),
          // 取得訂單資訊
          $.ajax({
            method: 'POST',
            url: '../php/getOrder.php',
            data:{},
            dataType: 'json',
            success: function(response) {
              console.log(response);
              response.forEach(function(index,i){
                member_block.orders = response;
              })
            },
            error: function(exception) {
              alert("發生錯誤: " + exception.status);
              console.log(exception);
            },
          })
        }
      })

    </script>
  </body>
</html>
